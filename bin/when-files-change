#!/usr/bin/env ruby
require 'listen'
require 'optparse'

require File.dirname(__FILE__) + '/../lib/file_glob'

listener = Listen.to('./')

opts = OptionParser.new do |opts|    
  opts.banner = "Usage: #{File.basename($0)} [options] -- command [arguments]"
  opts.separator ""
  
  opts.on("-i", "--ignore PATHS", Array, "Ignore changes made at these paths") do |paths|
    globs = paths.map{|p| FileGlob.new(p)}
    listener.ignore(*globs)
  end
end

def trigger(listener)
  listener.pause
  Kernel.system(* ARGV)
  listener.unpause
end

# Ignore Hidden Files:
listener.ignore(/^\.\w+/)

opts.parse! ARGV
if ARGV.length == 0
  puts opts
  exit 1 
end

listener.change do |modified, added, removed|
  trigger(listener)
end

# Start a non blocking Listener
listener.start(false)

# Catch signals so we can exit gracefully
trap('SIGINT' ){ puts; exit 1 }
trap('SIGQUIT'){ puts; exit 1 }

# Wait for a ctrl-d to quit
while char = STDIN.getc
  trigger listener if char == "\n"
end